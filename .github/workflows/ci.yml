name: CI/CD Pipeline - Complete Test Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  # ============================================================
  # Job 1: Build and TypeScript Check
  # ============================================================
  build:
    name: ðŸ—ï¸ Build & TypeScript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript strict mode check
        run: npx tsc --noEmit

      - name: Build application
        run: npm run build

      - name: Check build output
        run: |
          echo "ðŸ“¦ Build artifacts:"
          ls -lh dist/
          echo "ðŸ“Š Worker bundle size:"
          ls -lh dist/_worker.js

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # ============================================================
  # Job 2: Unit Tests
  # ============================================================
  unit-tests:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Run unit tests
        run: npm run test:unit -- --reporter=verbose

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/

  # ============================================================
  # Job 3: Integration Tests
  # ============================================================
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Run integration tests
        run: npm run test:integration -- --reporter=verbose

  # ============================================================
  # Job 4: Code Coverage
  # ============================================================
  coverage:
    name: ðŸ“Š Code Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  # ============================================================
  # Job 5: E2E Tests
  # ============================================================
  e2e-tests:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Run E2E tests
        run: npm run test:playwright -- --project=chromium
        env:
          CI: true

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

  # ============================================================
  # Job 6: Security Audit
  # ============================================================
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high || true

      - name: Check for vulnerable dependencies
        run: |
          echo "ðŸ” Checking for known vulnerabilities..."
          npm audit --json > audit-report.json || true
          cat audit-report.json | jq '.metadata.vulnerabilities'

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit-report.json

  # ============================================================
  # Job 7: Localization Tests
  # ============================================================
  localization-tests:
    name: ðŸŒ Localization Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Run localization tests
        run: npx vitest run tests/unit/localization.test.ts tests/unit/i18n.test.ts tests/integration/localization.test.ts --reporter=verbose

  # ============================================================
  # Job 8: Performance Tests
  # ============================================================
  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Run performance tests
        run: npx vitest run tests/unit/performance.test.ts --reporter=verbose

  # ============================================================
  # Job 9: API Health Check
  # ============================================================
  api-health:
    name: ðŸ¥ API Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Health check production API
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" https://moodmash.win/api/health)
          if [ "$response" != "200" ]; then
            echo "âŒ Health check failed with status: $response"
            exit 1
          fi
          echo "âœ… Health check passed"

      - name: Check response time
        run: |
          time=$(curl -s -o /dev/null -w "%{time_total}" https://moodmash.win/api/health)
          echo "â±ï¸ Response time: ${time}s"
          # Fail if response time > 2 seconds
          if (( $(echo "$time > 2.0" | bc -l) )); then
            echo "âš ï¸ Response time exceeds threshold"
          fi

  # ============================================================
  # Job 10: PWA Validation
  # ============================================================
  pwa-validation:
    name: ðŸ“± PWA Validation
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Validate manifest.json
        run: |
          if [ -f "public/manifest.json" ]; then
            echo "âœ… manifest.json exists"
            cat public/manifest.json | jq .
          else
            echo "âŒ manifest.json not found"
            exit 1
          fi

      - name: Validate service worker
        run: |
          if [ -f "public/sw.js" ]; then
            echo "âœ… Service worker exists"
          else
            echo "âŒ Service worker not found"
            exit 1
          fi

      - name: Check PWA icons
        run: |
          icons=$(ls public/icons/ 2>/dev/null | wc -l)
          echo "ðŸ“± Found $icons PWA icons"
          if [ "$icons" -lt 5 ]; then
            echo "âš ï¸ Fewer icons than expected"
          fi

  # ============================================================
  # Job 11: Compatibility Check
  # ============================================================
  compatibility:
    name: ðŸ”„ Compatibility Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Check Node.js compatibility
        run: node --version

      - name: Check package compatibility
        run: npm ls --depth=0

      - name: Verify Cloudflare Workers compatibility
        run: |
          echo "Checking for Cloudflare Workers compatibility..."
          # Check for Node.js-only APIs that won't work in Workers
          grep -r "require('fs')" src/ && echo "âš ï¸ fs module found" || echo "âœ… No fs module"
          grep -r "require('path')" src/ && echo "âš ï¸ path module found" || echo "âœ… No path module"

  # ============================================================
  # Job 12: Deploy to Production
  # ============================================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, unit-tests, integration-tests, security, localization-tests, performance-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository == 'salimemp/moodmash'
    environment:
      name: production
      url: https://moodmash.win
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Deploy to Cloudflare Pages
        if: env.CLOUDFLARE_API_TOKEN != ''
        run: npx wrangler pages deploy dist --project-name moodmash
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Post-deployment health check
        if: env.CLOUDFLARE_API_TOKEN != ''
        run: |
          sleep 30  # Wait for deployment to propagate
          response=$(curl -s -o /dev/null -w "%{http_code}" https://moodmash.win/api/health)
          if [ "$response" == "200" ]; then
            echo "âœ… Deployment successful - API healthy"
          else
            echo "âš ï¸ Deployment may have issues - API returned $response"
          fi

  # ============================================================
  # Job 13: Regression Tests (Nightly)
  # ============================================================
  regression:
    name: ðŸ” Regression Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci

      - name: Run full test suite
        run: npm test -- --reporter=verbose

      - name: Run E2E regression suite
        run: |
          npx playwright install --with-deps
          npm run test:playwright

  # ============================================================
  # Summary Job
  # ============================================================
  summary:
    name: ðŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [build, unit-tests, integration-tests, security, localization-tests, performance-tests, pwa-validation, compatibility]
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## ðŸ“‹ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Localization | ${{ needs.localization-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš¡ Performance | ${{ needs.performance-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± PWA | ${{ needs.pwa-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Compatibility | ${{ needs.compatibility.result }} |" >> $GITHUB_STEP_SUMMARY
