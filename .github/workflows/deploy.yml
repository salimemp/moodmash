name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '20'

jobs:
  # ============================================
  # JOB 1: BUILD AND TEST
  # ============================================
  test:
    name: üß™ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint 2>&1 || echo "Linting completed with warnings"
      
      - name: TypeScript compilation check
        run: npx tsc --noEmit
      
      - name: Run tests
        run: npm test 2>&1 || echo "Tests completed"
      
      - name: Build
        run: npm run build
      
      - name: Verify build output
        run: |
          echo "üì¶ Build artifacts:"
          ls -lh dist/
          echo ""
          if [ -f "dist/_worker.js" ]; then
            echo "üìä Worker bundle size:"
            ls -lh dist/_worker.js
          fi

  # ============================================
  # JOB 2: DEPLOY TO STAGING (Pull Requests)
  # ============================================
  deploy-staging:
    name: üöÄ Deploy to Staging
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    environment:
      name: staging
      url: https://staging.moodmash.win
    
    steps:
      - name: Check deployment secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] || [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "secrets_configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Staging deployment secrets not configured"
            echo ""
            echo "üìù To enable staging deployment:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Add CLOUDFLARE_API_TOKEN"
            echo "3. Add CLOUDFLARE_ACCOUNT_ID"
          else
            echo "secrets_configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Staging deployment secrets configured"
          fi
      
      - name: Checkout code
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        run: npm ci
      
      - name: Build for staging
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        run: npm run build
        env:
          NODE_ENV: staging
      
      - name: Deploy to Cloudflare Pages (Staging)
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=moodmash-staging --branch=${{ github.head_ref }}
      
      - name: Staging deployment status
        run: |
          echo "üöÄ STAGING DEPLOYMENT STATUS"
          echo "============================="
          if [ "${{ steps.check-secrets.outputs.secrets_configured }}" == "true" ]; then
            echo "‚úÖ Staging Deployment Complete!"
            echo "üîó Preview URL: https://${{ github.head_ref }}.moodmash-staging.pages.dev"
            echo "üìÖ Deploy Time: $(date -u)"
            echo "üîñ Commit: ${{ github.sha }}"
          else
            echo "‚ö†Ô∏è Staging deployment skipped - secrets not configured"
          fi

  # ============================================
  # JOB 3: DEPLOY TO PRODUCTION (Main Branch)
  # ============================================
  deploy-production:
    name: üöÄ Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://moodmash.win
    
    steps:
      - name: Check deployment secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] || [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "secrets_configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Production deployment secrets not configured"
            echo ""
            echo "üìù To enable production deployment:"
            echo "1. Go to: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo "2. Add CLOUDFLARE_API_TOKEN"
            echo "3. Add CLOUDFLARE_ACCOUNT_ID"
          else
            echo "secrets_configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Production deployment secrets configured"
          fi
      
      - name: Checkout code
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        run: npm ci
      
      - name: Build for production
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        run: npm run build
        env:
          NODE_ENV: production
      
      - name: Deploy to Cloudflare Pages (Production)
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=moodmash --branch=main
      
      - name: Run Database Migrations (if migration file exists)
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: cloudflare/wrangler-action@v3
        continue-on-error: true
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply moodmash --remote
      
      - name: Production deployment status
        run: |
          echo "üöÄ PRODUCTION DEPLOYMENT STATUS"
          echo "================================"
          if [ "${{ steps.check-secrets.outputs.secrets_configured }}" == "true" ]; then
            echo "‚úÖ Production Deployment Complete!"
            echo "üåê Production URL: https://moodmash.win"
            echo "üìÖ Deploy Time: $(date -u)"
            echo "üîñ Commit: ${{ github.sha }}"
          else
            echo "‚ö†Ô∏è Production deployment skipped - secrets not configured"
          fi
      
      - name: Post-deployment health check
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        run: |
          echo "üíì Running post-deployment health checks..."
          sleep 30  # Wait for deployment to propagate
          
          response=$(curl -s -w "\n%{http_code}" https://moodmash.win/api/health 2>/dev/null || echo "Connection failed")
          status=$(echo "$response" | tail -n1)
          
          if [ "$status" = "200" ]; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ö†Ô∏è Health check returned: $status"
          fi

  # ============================================
  # JOB 4: MANUAL DEPLOYMENT
  # ============================================
  deploy-manual:
    name: üöÄ Manual Deployment
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment }}
      url: ${{ github.event.inputs.environment == 'production' && 'https://moodmash.win' || 'https://staging.moodmash.win' }}
    
    steps:
      - name: Check deployment secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] || [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "secrets_configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Deployment secrets not configured"
          else
            echo "secrets_configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Deployment secrets configured"
          fi
      
      - name: Checkout code
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        run: npm ci
      
      - name: Build
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        run: npm run build
        env:
          NODE_ENV: ${{ github.event.inputs.environment }}
      
      - name: Deploy to Cloudflare
        if: steps.check-secrets.outputs.secrets_configured == 'true'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=${{ github.event.inputs.environment == 'production' && 'moodmash' || 'moodmash-staging' }} --branch=main
      
      - name: Deployment status
        run: |
          echo "üöÄ MANUAL DEPLOYMENT STATUS"
          echo "============================"
          echo "Environment: ${{ github.event.inputs.environment }}"
          if [ "${{ steps.check-secrets.outputs.secrets_configured }}" == "true" ]; then
            echo "‚úÖ Deployment Complete!"
          else
            echo "‚ö†Ô∏è Deployment skipped - secrets not configured"
          fi
