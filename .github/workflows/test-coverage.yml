name: Test Coverage

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - uses: actions/checkout@v3
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Create test environment file
      run: |
        cat > .env.test << EOL
        DATABASE_URL="file:./test.db"
        REDIS_URL="redis://localhost:6379"
        NEXTAUTH_URL="http://localhost:3000"
        NEXTAUTH_SECRET="test-secret-do-not-use-in-production"
        ENCRYPTION_KEY="test-key-32-chars-do-not-use-prod"
        SMTP_HOST="localhost"
        SMTP_PORT="1025"
        SMTP_USER="test"
        SMTP_PASSWORD="test"
        SMTP_FROM="test@example.com"
        OPENAI_API_KEY="sk-test"
        NEXT_PUBLIC_POSTHOG_KEY="phc_test"
        NEXT_PUBLIC_POSTHOG_HOST="https://app.posthog.com"
        NEXT_PUBLIC_ENABLE_ANALYTICS="false"
        NEXT_PUBLIC_SENTRY_DSN=""
        NEXT_PUBLIC_ENVIRONMENT="test"
        EOL
    
    - name: Run tests with coverage
      run: npm run test
    
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        directory: ./coverage
        flags: unittests
        fail_ci_if_error: true
        verbose: true
    
    - name: Save coverage report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/
    
    - name: Check test coverage meets thresholds
      run: |
        if grep -q "ERROR: Coverage for" coverage/coverage-final.txt; then
          echo "Test coverage thresholds not met. See coverage report for details."
          exit 1
        fi 