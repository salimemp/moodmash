name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
      confirm:
        description: 'Type "MIGRATE" to confirm'
        required: true

jobs:
  validate-input:
    name: Validate Migration Request
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "MIGRATE" ]; then
            echo "‚ùå Migration cancelled: confirmation not provided"
            echo "Please type MIGRATE to confirm"
            exit 1
          fi
          echo "‚úÖ Migration confirmed"

  apply-migrations:
    name: Apply Database Migrations
    runs-on: ubuntu-latest
    needs: validate-input
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: List available migrations
        run: |
          echo "üìã Available migrations:"
          ls -la migrations/*.sql || echo "No migrations found"
      
      - name: Apply migrations (Production)
        if: github.event.inputs.environment == 'production'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üöÄ Applying migrations to PRODUCTION database..."
          wrangler d1 migrations apply moodmash --remote
      
      - name: Verify migrations
        if: github.event.inputs.environment == 'production'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "‚úÖ Verifying database structure..."
          wrangler d1 execute moodmash --remote --command="SELECT name FROM sqlite_master WHERE type='table' ORDER BY name;"
      
      - name: Migration summary
        run: |
          echo "üìä Migration Summary:"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date)"
          echo ""
          echo "‚úÖ Database migrations completed successfully"

  post-migration-health-check:
    name: Post-Migration Health Check
    runs-on: ubuntu-latest
    needs: apply-migrations
    
    steps:
      - name: Wait for changes to propagate
        run: sleep 15
      
      - name: Test database connectivity
        run: |
          echo "üîç Testing database connectivity..."
          response=$(curl -s https://moodmash.pages.dev/api/health/status)
          echo "$response"
          
          if echo "$response" | grep -q "healthy"; then
            echo "‚úÖ Database is healthy after migration"
          else
            echo "‚ö†Ô∏è Database health check shows warnings"
          fi
